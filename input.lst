     1                                  ; file.asm - использование файлов в NASM
     2                                  extern printf
     3                                  extern fscanf
     4                                  extern fprintf
     5                                  
     6                                  extern COMPLEX
     7                                  extern FRACTION
     8                                  extern POLAR
     9                                  
    10                                  ;----------------------------------------------
    11                                  ;  Ввод параметров комплексного числа из файла
    12                                  ;----------------------------------------------
    13                                  global InComplex
    14                                  InComplex:
    15                                  section .data
    16 00000000 2564256400                  .infmt db "%d%d",0
    17                                  section .bss
    18 00000000 <res 00000008>              .FILE   resq    1   ; временное хранение указателя на файл
    19 00000008 <res 00000008>              .comp  resq    1   ; адрес комплексного числа
    20                                  section .text
    21 00000000 55                      push rbp
    22 00000001 4889E5                  mov rbp, rsp
    23                                  
    24                                      ; Сохранение принятых аргументов
    25 00000004 48893C25[08000000]          mov     [.comp], rdi          ; сохраняется адрес комплексного числа
    26 0000000C 48893425[00000000]          mov     [.FILE], rsi          ; сохраняется указатель на файл
    27                                  
    28                                      ; Ввод комплексного числа из файла
    29 00000014 488B3C25[00000000]          mov     rdi, [.FILE]
    30 0000001C 48BE-                       mov     rsi, .infmt         ; Формат - 1-й аргумент
    30 0000001E [0000000000000000] 
    31 00000026 488B1425[08000000]          mov     rdx, [.comp]        ; &x
    32 0000002E 488B0C25[08000000]          mov     rcx, [.comp]
    33 00000036 4883C104                    add     rcx, 4              ; &y = &x + 4
    34 0000003A B800000000                  mov     rax, 0              ; нет чисел с плавающей точкой
    35 0000003F E8(00000000)                call    fscanf
    36                                  
    37 00000044 C9                      leave
    38 00000045 C3                      ret
    39                                  
    40                                  ;-------------------------------------------
    41                                  ; Ввод параметров треугольника из файла
    42                                  ;-------------------------------------------
    43                                  global InFraction
    44                                  InFraction:
    45                                  section .data
    46 00000005 25642564256400              .infmt db "%d%d%d",0
    47                                  section .bss
    48 00000010 <res 00000008>              .FILE   resq    1   ; временное хранение указателя на файл
    49 00000018 <res 00000008>              .frac   resq    1   ; адрес дроби
    50                                  section .text
    51 00000046 55                      push rbp
    52 00000047 4889E5                  mov rbp, rsp
    53                                  
    54                                      ; Сохранение принятых аргументов
    55 0000004A 48893C25[18000000]          mov     [.frac], rdi          ; сохраняется адрес дроби
    56 00000052 48893425[10000000]          mov     [.FILE], rsi          ; сохраняется указатель на файл
    57                                  
    58                                      ; Ввод дроби из файла
    59 0000005A 488B3C25[10000000]          mov     rdi, [.FILE]
    60 00000062 48BE-                       mov     rsi, .infmt         ; Формат - 1-й аргумент
    60 00000064 [0500000000000000] 
    61 0000006C 488B1425[18000000]          mov     rdx, [.frac]        ; &a
    62 00000074 488B0C25[18000000]          mov     rcx, [.frac]
    63 0000007C 4883C104                    add     rcx, 4              ; &b = &a + 4
    64 00000080 B800000000                  mov     rax, 0              ; нет чисел с плавающей точкой
    65 00000085 E8(00000000)                call    fscanf
    66                                  
    67 0000008A C9                      leave
    68 0000008B C3                      ret
    69                                  
    70                                  ;------------------------------------
    71                                  ; Ввод полярной координаты из файла
    72                                  ;------------------------------------
    73                                  global InPolar
    74                                  InPolar:
    75                                  section .data
    76 0000000C 25642564256400              .infmt db "%d%d%d",0
    77                                  section .bss
    78 00000020 <res 00000008>              .FILE   resq    1   ; временное хранение указателя на файл
    79 00000028 <res 00000008>              .pol    resq    1   ; адрес полярной коорддинаты
    80                                  section .text
    81 0000008C 55                      push rbp
    82 0000008D 4889E5                  mov rbp, rsp
    83                                  
    84                                      ; Сохранение принятых аргументов
    85 00000090 48893C25[28000000]          mov     [.pol], rdi           ; сохраняется адрес полярной координаты
    86 00000098 48893425[20000000]          mov     [.FILE], rsi          ; сохраняется указатель на файл
    87                                  
    88                                      ; Ввод полярной координаты из файла
    89 000000A0 488B3C25[20000000]          mov     rdi, [.FILE]
    90 000000A8 48BE-                       mov     rsi, .infmt         ; Формат - 1-й аргумент
    90 000000AA [0C00000000000000] 
    91 000000B2 488B1425[28000000]          mov     rdx, [.pol]         ; &r
    92 000000BA 488B0C25[28000000]          mov     rcx, [.pol]
    93 000000C2 4883C104                    add     rcx, 4              ; &phi = &r + 4
    94 000000C6 B800000000                  mov     rax, 0              ; нет чисел с плавающей точкой
    95 000000CB E8(00000000)                call    fscanf
    96                                  
    97 000000D0 C9                      leave
    98 000000D1 C3                      ret
    99                                  
   100                                  ;----------------------------------------------
   101                                  ; Ввод параметров обобщенного числа из файла
   102                                  ;----------------------------------------------
   103                                  global InNumber
   104                                  InNumber:
   105                                  section .data
   106 00000013 256400                      .tagFormat   db      "%d",0
   107 00000016 5461672069733A2025-         .tagOutFmt   db      "Tag is: %d",10,0
   107 0000001F 640A00             
   108                                  section .bss
   109 00000030 <res 00000008>              .FILE       resq    1   ; временное хранение указателя на файл
   110 00000038 <res 00000008>              .pnum       resq    1   ; адрес числа
   111 00000040 <res 00000004>              .numTag     resd    1   ; признак числа
   112                                  section .text
   113 000000D2 55                      push rbp
   114 000000D3 4889E5                  mov rbp, rsp
   115                                  
   116                                      ; Сохранение принятых аргументов
   117 000000D6 48893C25[38000000]          mov     [.pnum], rdi            ; сохраняется адрес числа
   118 000000DE 48893425[30000000]          mov     [.FILE], rsi            ; сохраняется указатель на файл
   119                                  
   120                                      ; чтение признака числа и его обработка
   121 000000E6 488B3C25[30000000]          mov     rdi, [.FILE]
   122 000000EE 48BE-                       mov     rsi, .tagFormat
   122 000000F0 [1300000000000000] 
   123 000000F8 488B1425[38000000]          mov     rdx, [.pnum]        ; адрес начала числа (ее признак)
   124 00000100 4831C0                      xor     rax, rax            ; нет чисел с плавающей точкой
   125 00000103 E8(00000000)                call    fscanf
   126                                  
   127                                      ; Тестовый вывод признака фигуры
   128                                  ;     mov     rdi, .tagOutFmt
   129                                  ;     mov     rax, [.pshape]
   130                                  ;     mov     esi, [rax]
   131                                  ;     call    printf
   132                                  
   133 00000108 488B0C25[38000000]          mov rcx, [.pnum]            ; загрузка адреса начала числа
   134 00000110 8B01                        mov eax, [rcx]              ; и получение прочитанного признака
   135 00000112 3B0425[00000000]            cmp eax, [COMPLEX]
   136 00000119 7416                        je .compIn
   137 0000011B 3B0425[00000000]            cmp eax, [FRACTION]
   138 00000122 742D                        je .fracIn
   139 00000124 3B0425[00000000]            cmp eax, [POLAR]
   140 0000012B 7444                        je .polIn
   141 0000012D 31C0                        xor eax, eax                ; Некорректный признак - обнуление кода возврата
   142 0000012F EB5E                        jmp     .return
   143                                  .compIn:
   144                                      ; Ввод комплексного числа
   145 00000131 488B3C25[38000000]          mov     rdi, [.pnum]
   146 00000139 4883C704                    add     rdi, 4
   147 0000013D 488B3425[30000000]          mov     rsi, [.FILE]
   148 00000145 E8B6FEFFFF                  call    InComplex
   149 0000014A B801000000                  mov     rax, 1  ; Код возврата - true
   150 0000014F EB3E                        jmp     .return
   151                                  .fracIn:
   152                                      ; Ввод дроби
   153 00000151 488B3C25[38000000]          mov     rdi, [.pnum]
   154 00000159 4883C704                    add     rdi, 4
   155 0000015D 488B3425[30000000]          mov     rsi, [.FILE]
   156 00000165 E8DCFEFFFF                  call    InFraction
   157 0000016A B801000000                  mov     rax, 1  ; Код возврата - true
   158 0000016F EB1E                        jmp     .return
   159                                  .polIn:
   160                                      ; Ввод полярной координаты
   161 00000171 488B3C25[38000000]          mov     rdi, [.pnum]
   162 00000179 4883C704                    add     rdi, 4
   163 0000017D 488B3425[30000000]          mov     rsi, [.FILE]
   164 00000185 E802FFFFFF                  call    InPolar
   165 0000018A B801000000                  mov     rax, 1  ; Код возврата - true
   166                                  .return:
   167                                  
   168 0000018F C9                      leave
   169 00000190 C3                      ret
   170                                  
   171                                  ;----------------------------------------------------
   172                                  ; Ввод содержимого контейнера из указанного файла
   173                                  ;----------------------------------------------------
   174                                  global InContainer
   175                                  InContainer:
   176                                  section .bss
   177 00000044 <res 00000008>              .pcont  resq    1   ; адрес контейнера
   178 0000004C <res 00000008>              .plen   resq    1   ; адрес для сохранения числа введенных элементов
   179 00000054 <res 00000008>              .FILE   resq    1   ; указатель на файл
   180                                  section .text
   181 00000191 55                      push rbp
   182 00000192 4889E5                  mov rbp, rsp
   183                                  
   184 00000195 48893C25[44000000]          mov [.pcont], rdi   ; сохраняется указатель на контейнер
   185 0000019D 48893425[4C000000]          mov [.plen], rsi    ; сохраняется указатель на длину
   186 000001A5 48891425[54000000]          mov [.FILE], rdx    ; сохраняется указатель на файл
   187                                      ; В rdi адрес начала контейнера
   188 000001AD 4831DB                      xor rbx, rbx        ; число чисел = 0
   189 000001B0 4889D6                      mov rsi, rdx        ; перенос указателя на файл
   190                                  .loop:
   191                                      ; сохранение рабочих регистров
   192 000001B3 57                          push rdi
   193 000001B4 53                          push rbx
   194                                  
   195 000001B5 488B3425[54000000]          mov     rsi, [.FILE]
   196 000001BD B800000000                  mov     rax, 0      ; нет чисел с плавающей точкой
   197 000001C2 E80BFFFFFF                  call    InNumber    ; ввод числа
   198 000001C7 4883F800                    cmp rax, 0          ; проверка успешности ввода
   199 000001CB 7E0B                        jle  .return        ; выход, если признак меньше или равен 0
   200                                  
   201 000001CD 5B                          pop rbx
   202 000001CE 48FFC3                      inc rbx
   203                                  
   204 000001D1 5F                          pop rdi
   205 000001D2 4883C710                    add rdi, 16             ; адрес следующего числа
   206                                  
   207 000001D6 EBDB                        jmp .loop
   208                                  .return:
   209 000001D8 488B0425[4C000000]          mov rax, [.plen]    ; перенос указателя на длину
   210 000001E0 8918                        mov [rax], ebx      ; занесение длины
   211 000001E2 C9                      leave
   212 000001E3 C3                      ret
   213                                  
