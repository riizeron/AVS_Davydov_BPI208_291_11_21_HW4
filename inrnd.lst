     1                                  ; file.asm - использование файлов в NASM
     2                                  extern printf
     3                                  extern rand
     4                                  
     5                                  extern COMPLEX
     6                                  extern POLAR
     7                                  extern FRACTION 
     8                                  
     9                                  ;--------------------------------------------------------------------
    10                                  ; rnd.c - содержит генератор случайных чисел в диапазоне от 1 до 20
    11                                  ;--------------------------------------------------------------------
    12                                  global Random
    13                                  Random:
    14                                  section .data
    15 00000000 1400000000000000            .i20     dq      20
    16 00000008 52616E646F6D206E75-         .rndNumFmt       db "Random number = %d",10,0
    16 00000011 6D626572203D202564-
    16 0000001A 0A00               
    17                                  section .text
    18 00000000 55                      push rbp
    19 00000001 4889E5                  mov rbp, rsp
    20                                  
    21 00000004 4831C0                      xor     rax, rax    ;
    22 00000007 E8(00000000)                call    rand        ; запуск генератора случайных чисел
    23 0000000C 4831D2                      xor     rdx, rdx    ; обнуление перед делением
    24 0000000F 48F73C25[00000000]          idiv    qword[.i20]       ; (/%) -> остаток в rdx
    25 00000017 4889D0                      mov     rax, rdx
    26 0000001A 48FFC0                      inc     rax         ; должно сформироваться случайное число
    27                                  
    28                                      ;mov     rdi, .rndNumFmt
    29                                      ;mov     esi, eax
    30                                      ;xor     rax, rax
    31                                      ;call    printf
    32                                  
    33                                  
    34 0000001D C9                      leave
    35 0000001E C3                      ret
    36                                  
    37                                  ;----------------------------------------------
    38                                  ; Случайный ввод параметров комплексного числа
    39                                  ;----------------------------------------------
    40                                  global InRndComplex
    41                                  InRndComplex:
    42                                  section .bss
    43 00000000 <res 00000008>              .pcomp  resq 1   ; адрес комплексного числа
    44                                  section .text
    45 0000001F 55                      push rbp
    46 00000020 4889E5                  mov rbp, rsp
    47                                  
    48                                      ; В rdi адрес комплексного числа
    49 00000023 48893C25[00000000]          mov     [.pcomp], rdi
    50                                      ; Генерация значений комплексного числа
    51 0000002B E8D0FFFFFF                  call    Random
    52 00000030 488B1C25[00000000]          mov     rbx, [.pcomp]
    53 00000038 8903                        mov     [rbx], eax
    54 0000003A E8C1FFFFFF                  call    Random
    55 0000003F 488B1C25[00000000]          mov     rbx, [.pcomp]
    56 00000047 894304                      mov     [rbx+4], eax
    57                                  
    58 0000004A C9                      leave
    59 0000004B C3                      ret
    60                                  
    61                                  ;----------------------------------------------
    62                                  ; Случайный ввод параметров дроби
    63                                  ;----------------------------------------------
    64                                  global InRndFraction
    65                                  InRndFraction:
    66                                  section .bss
    67 00000008 <res 00000008>              .pfrac  resq 1   ; адрес дроби
    68                                  section .text
    69 0000004C 55                      push rbp
    70 0000004D 4889E5                  mov rbp, rsp
    71                                  
    72                                      ; В rdi адрес дроби
    73 00000050 48893C25[08000000]          mov     [.pfrac], rdi
    74                                      ; Генерация числителя и значенателя
    75 00000058 E8A3FFFFFF                  call    Random
    76 0000005D 488B1C25[08000000]          mov     rbx, [.pfrac]
    77 00000065 8903                        mov     [rbx], eax
    78                                  .repeat:
    79 00000067 E894FFFFFF                  call    Random
    80 0000006C 488B1C25[08000000]          mov     rbx, [.pfrac]
    81 00000074 894304                      mov     [rbx+4], eax
    82 00000077 89C3                        mov     ebx, eax        ; знамеатель
    83 00000079 83FB00                      cmp     ebx, 0          ; проверка на то что значенатель равен нулю
    84 0000007C 74E9                        je      .repeat
    85                                  
    86 0000007E C9                      leave
    87 0000007F C3                      ret
    88                                  
    89                                  ;-----------------------------------------------
    90                                  ; Случайный ввод знаяений полярной координаты
    91                                  ;-----------------------------------------------
    92                                  global InRndPolar
    93                                  InRndPolar:
    94                                  section .bss
    95 00000010 <res 00000008>              .ppol  resq 1   ; адрес полярной координаты
    96                                  section .text
    97 00000080 55                      push rbp
    98 00000081 4889E5                  mov rbp, rsp
    99                                  
   100                                      ; В rdi адрес полярной координаты
   101 00000084 48893C25[10000000]          mov     [.ppol], rdi
   102                                      ; Генерация значений полярной координаты
   103 0000008C E86FFFFFFF                  call    Random
   104 00000091 488B1C25[10000000]          mov     rbx, [.ppol]
   105 00000099 894304                      mov     [rbx+4], eax    ; угол
   106                                  .repeat:
   107 0000009C E85FFFFFFF                  call    Random
   108 000000A1 488B1C25[10000000]          mov     rbx, [.ppol]
   109 000000A9 8903                        mov     [rbx], eax
   110 000000AB 89C3                        mov     ebx, eax        ; радиус
   111 000000AD 83FB00                      cmp     ebx, 0          ; проверка на отрицательность радиуса
   112 000000B0 78EA                        js      .repeat
   113                                  
   114 000000B2 C9                      leave
   115 000000B3 C3                      ret
   116                                  
   117                                  
   118                                  ;----------------------------------------------
   119                                  ; Случайный ввод обобщенного числа
   120                                  ;----------------------------------------------
   121                                  global InRndNmber
   122                                  InRndNumber:
   123                                  section .data
   124 0000001C 0300000000000000            .keys       dq 3
   125                                  section .bss
   126 00000018 <res 00000008>              .pnum       resq    1   ; адрес числа
   127 00000020 <res 00000004>              .key        resd    1   ; ключ
   128                                  section .text
   129 000000B4 55                      push rbp
   130 000000B5 4889E5                  mov rbp, rsp
   131                                  
   132                                      ; В rdi адрес числа
   133 000000B8 48893C25[18000000]          mov [.pnum], rdi
   134                                      
   135                                      ; Формирование признака числа
   136 000000C0 31C0                        xor     eax, eax    ;
   137 000000C2 E8(00000000)                call    rand        ; запуск генератора случайных чисел
   138                                      
   139 000000C7 31D2                        xor     edx, edx
   140 000000C9 48F73C25[1C000000]          idiv    qword[.keys]
   141 000000D1 89D0                        mov     eax, edx      ; очистка результата кроме младшего разряда (0 или 1)
   142 000000D3 FFC0                        inc     eax         ; фомирование признака числа (1 или 2 или 3)
   143                                  
   144                                      ;mov     [.key], eax
   145                                      ;mov     rdi, .rndNumFmt
   146                                      ;mov     esi, [.key]
   147                                      ;xor     rax, rax
   148                                      ;call    printf
   149                                      ;mov     eax, [.key]
   150                                  
   151 000000D5 488B3C25[18000000]          mov     rdi, [.pnum]
   152 000000DD 8907                        mov     [rdi], eax      ; запись ключа в фигуру
   153 000000DF 3B0425[00000000]            cmp eax, [COMPLEX]
   154 000000E6 7416                        je .compInRnd
   155 000000E8 3B0425[00000000]            cmp eax, [FRACTION]
   156 000000EF 741D                        je .fracInRnd
   157 000000F1 3B0425[00000000]            cmp eax, [POLAR]
   158 000000F8 7424                        je .polInRnd
   159 000000FA 31C0                        xor eax, eax        ; код возврата = 0
   160 000000FC EB2E                        jmp     .return
   161                                  .compInRnd:
   162                                      ; Генерация комплексного числав
   163 000000FE 4883C704                    add     rdi, 4
   164 00000102 E818FFFFFF                  call    InRndComplex
   165 00000107 B801000000                  mov     eax, 1      ;код возврата = 1
   166 0000010C EB1E                        jmp     .return
   167                                  .fracInRnd:
   168                                      ; Генерация дроби
   169 0000010E 4883C704                    add     rdi, 4
   170 00000112 E835FFFFFF                  call    InRndFraction
   171 00000117 B801000000                  mov     eax, 1      ;код возврата = 1
   172 0000011C EB0E                        jmp     .return
   173                                  .polInRnd:
   174                                      ; Генерация полярной координаты
   175 0000011E 4883C704                    add     rdi, 4
   176 00000122 E859FFFFFF                  call    InRndPolar
   177 00000127 B801000000                  mov     eax, 1      ;код возврата = 1
   178                                  .return:
   179 0000012C C9                      leave
   180 0000012D C3                      ret
   181                                  
   182                                  ;----------------------------------------------
   183                                  ; Случайный ввод содержимого контейнера
   184                                  ;----------------------------------------------
   185                                  global InRndContainer
   186                                  InRndContainer:
   187                                  section .bss
   188 00000024 <res 00000008>              .pcont  resq    1   ; адрес контейнера
   189 0000002C <res 00000008>              .plen   resq    1   ; адрес для сохранения числа введенных элементов
   190 00000034 <res 00000004>              .psize  resd    1   ; число порождаемых элементов
   191                                  section .text
   192 0000012E 55                      push rbp
   193 0000012F 4889E5                  mov rbp, rsp
   194                                  
   195 00000132 48893C25[24000000]          mov [.pcont], rdi   ; сохраняется указатель на контейнер
   196 0000013A 48893425[2C000000]          mov [.plen], rsi    ; сохраняется указатель на длину
   197 00000142 891425[34000000]            mov [.psize], edx   ; сохраняется число порождаемых элементов
   198                                      ; В rdi адрес начала контейнера
   199 00000149 31DB                        xor ebx, ebx        ; число чисел = 0
   200                                  .loop:
   201 0000014B 39D3                        cmp ebx, edx
   202 0000014D 7D1A                        jge     .return
   203                                      ; сохранение рабочих регистров
   204 0000014F 57                          push rdi
   205 00000150 53                          push rbx
   206 00000151 52                          push rdx
   207                                  
   208 00000152 E85DFFFFFF                  call    InRndNumber     ; ввод числа
   209 00000157 4883F800                    cmp rax, 0          ; проверка успешности ввода
   210 0000015B 7E0C                        jle  .return        ; выход, если признак меньше или равен 0
   211                                  
   212 0000015D 5A                          pop rdx
   213 0000015E 5B                          pop rbx
   214 0000015F 48FFC3                      inc rbx
   215                                  
   216 00000162 5F                          pop rdi
   217 00000163 4883C720                    add rdi, 32            ; адрес следующего числа
   218                                  
   219 00000167 EBE2                        jmp .loop
   220                                  .return:
   221 00000169 488B0425[2C000000]          mov rax, [.plen]    ; перенос указателя на длину
   222 00000171 8918                        mov [rax], ebx      ; занесение длины
   223 00000173 C9                      leave
   224 00000174 C3                      ret
