     1                                  ;---------------------------------------------------------------------------------------
     2                                  ; real.asm - единица компиляции, вбирающая функции вычисления вещественной части числа
     3                                  ;---------------------------------------------------------------------------------------
     4                                  
     5                                  extern COMPLEX
     6                                  extern FRACTION
     7                                  extern POLAR        
     8                                  
     9                                  extern printf
    10                                  
    11                                  ;-------------------------------------------------------
    12                                  ; Вычисление вещественного значения комплексного числа
    13                                  ;-------------------------------------------------------
    14                                  global RealComplex
    15                                  RealComplex:
    16                                  section .text
    17 00000000 55                      push rbp
    18 00000001 4889E5                  mov rbp, rsp
    19                                  
    20                                      ; В rdi адрес комплексного числа
    21 00000004 8B07                        mov eax, [rdi]
    22 00000006 0FAFC0                      imul eax, eax                 ; x*x
    23 00000009 8B4F04                      mov ecx, [rdi+4]
    24 0000000C 0FAFC9                      imul ecx, ecx                 ; y*y
    25 0000000F 01C8                        add eax, ecx 
    26 00000011 F20F2AC0                    cvtsi2sd xmm0, eax            ; x*x+y*y
    27 00000015 F20F51C0                    sqrtsd xmm0, xmm0             ; sqrt(x*x+y*y)
    28                                  
    29 00000019 C9                      leave
    30 0000001A C3                      ret
    31                                  
    32                                  ;----------------------------------------------
    33                                  ; Вычисление вещественного значчения дроби
    34                                  ;----------------------------------------------
    35                                  global RealFraction
    36                                  RealFraction:
    37                                  section .text
    38 0000001B 55                      push rbp
    39 0000001C 4889E5                  mov rbp, rsp
    40                                  
    41                                      ; В rdi адрес дроби
    42 0000001F 8B07                        mov eax, [rdi]              ; числитель
    43 00000021 8B5704                      mov edx, [rdi+4]
    44 00000024 F20F2AC0                    cvtsi2sd    xmm0, eax
    45 00000028 F20F2ACA                    cvtsi2sd    xmm1, edx  
    46 0000002C F20F5EC1                    divsd xmm0, xmm1                ; числитель / знаменатель
    47                                  
    48 00000030 C9                      leave
    49 00000031 C3                      ret
    50                                  
    51                                  ;---------------------------------------------------------
    52                                  ; Вычисление вещественного значения полярной координаты
    53                                  ;---------------------------------------------------------
    54                                  global RealPolar
    55                                  RealPolar:
    56                                  section .text
    57 00000032 55                      push rbp
    58 00000033 4889E5                  mov rbp, rsp
    59                                  
    60                                      ; В rdi адрес полярной координаты
    61 00000036 8B07                        mov eax, [rdi]              ; радиус
    62 00000038 F20F2AC0                    cvtsi2sd    xmm0, eax
    63                                  
    64 0000003C C9                      leave
    65 0000003D C3                      ret
    66                                  
    67                                  ;----------------------------------------------
    68                                  ; Вычисление вещественного значения числа
    69                                  ;----------------------------------------------
    70                                  global RealNumber
    71                                  RealNumber:
    72                                  section .text
    73 0000003E 55                      push rbp
    74 0000003F 4889E5                  mov rbp, rsp
    75                                  
    76                                      ; В rdi адрес числа
    77 00000042 8B07                        mov eax, [rdi]
    78 00000044 3B0425[00000000]            cmp eax, [COMPLEX]
    79 0000004B 741A                        je compReal
    80 0000004D 3B0425[00000000]            cmp eax, [FRACTION]
    81 00000054 741C                        je fracReal
    82 00000056 3B0425[00000000]            cmp eax, [POLAR]
    83 0000005D 741E                        je polReal
    84 0000005F 31C0                        xor eax, eax
    85 00000061 F20F2AC0                    cvtsi2sd    xmm0, eax
    86 00000065 EB1F                        jmp     return
    87                                  compReal:
    88                                      ; Вычисление вещественного значенияп комплексного числа
    89 00000067 4883C704                    add     rdi, 4
    90 0000006B E890FFFFFF                  call    RealComplex
    91 00000070 EB14                        jmp     return
    92                                  fracReal:
    93                                      ; Вычисление вещественного значения дроби
    94 00000072 4883C704                    add     rdi, 4
    95 00000076 E8A0FFFFFF                  call    RealFraction
    96 0000007B EB09                        jmp     return
    97                                  polReal:
    98                                      ; Вычисление вещественного значения полярной координаты
    99 0000007D 4883C704                    add     rdi, 4
   100 00000081 E8ACFFFFFF                  call    RealPolar
   101                                  return:
   102 00000086 C9                      leave
   103 00000087 C3                      ret
   104                                  
   105                                  ;-----------------------------------------------------------------------
   106                                  ; Вычисление среднего вещественного значения всхе числе в контейнере
   107                                  ;-----------------------------------------------------------------------
   108                                  global ContainerRealAverage
   109                                  ContainerRealAverage:
   110                                  section .data
   111 00000000 0000000000000000            .sum    dq  0.0   
   112                                  section .text
   113 00000088 55                      push rbp
   114 00000089 4889E5                  mov rbp, rsp
   115                                  
   116                                      ; В rdi адрес начала контейнера
   117 0000008C 89F3                        mov     ebx, esi        ; число фигур
   118 0000008E 31C9                        xor     ecx, ecx        ; счетчик фигур
   119 00000090 F20F101425-                 movsd   xmm2, [.sum]    ; перенос накопителя суммы в регистр 2
   119 00000095 [00000000]         
   120                                  
   121                                  .loop:
   122 00000099 39D9                        cmp     ecx, ebx        ; проверка на окончание цикла
   123 0000009B 7D1B                        jge     .return         ; перебрали все фигуры
   124                                  
   125 0000009D 53                          push rbx
   126 0000009E 51                          push rcx
   127                                  
   128 0000009F 4989FA                      mov     r10, rdi        ; сохранение начала фигуры
   129 000000A2 E897FFFFFF                  call    RealNumber  ; получение периметра фигуры
   130 000000A7 F20F58D0                    addsd   xmm2, xmm0      ; накопление суммы периметров
   131                                  
   132 000000AB 59                          pop rcx
   133 000000AC 5B                          pop rbx
   134 000000AD FFC1                        inc ecx
   135                                  
   136 000000AF 4983C220                    add     r10, 32         ; адрес следующей фигуры
   137 000000B3 4C89D7                      mov     rdi, r10        ; восстановление для передачи параметра
   138 000000B6 EBE1                        jmp     .loop
   139                                  .return:
   140 000000B8 F20F2ACB                    cvtsi2sd    xmm1, ebx
   141 000000BC F20F5ED1                    divsd   xmm2, xmm1
   142 000000C0 F20F10C2                    movsd   xmm0, xmm2
   143 000000C4 C9                      leave
   144 000000C5 C3                      ret
