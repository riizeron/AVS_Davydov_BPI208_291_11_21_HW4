     1                                  ; file.asm - использование файлов в NASM
     2                                  extern printf
     3                                  extern fprintf
     4                                  
     5                                  extern RealComplex
     6                                  extern RealFraction
     7                                  extern RealPolar
     8                                  
     9                                  extern COMPLEX
    10                                  extern FRACTION
    11                                  extern POLAR
    12                                  
    13                                  ;----------------------------------------------
    14                                  ; Вывод параметров комплексного числа в файл
    15                                  ;----------------------------------------------
    16                                  global OutComplex
    17                                  OutComplex:
    18                                  section .data
    19 00000000 497420697320436F6D-         .outfmt db "It is Complex: x = %d, y = %d. Real = %g",10,0
    19 00000009 706C65783A2078203D-
    19 00000012 2025642C2079203D20-
    19 0000001B 25642E205265616C20-
    19 00000024 3D2025670A00       
    20                                  section .bss
    21 00000000 <res 00000008>              .pcomp  resq  1
    22 00000008 <res 00000008>              .FILE   resq  1       ; временное хранение указателя на файл
    23 00000010 <res 00000008>              .p      resq  1       ; вычисленное вещественного значение комплексного числа
    24                                  section .text
    25 00000000 55                      push rbp
    26 00000001 4889E5                  mov rbp, rsp
    27                                  
    28                                      ; Сохранени принятых аргументов
    29 00000004 48893C25[00000000]          mov     [.pcomp], rdi          ; сохраняется адрес комплексного чсила
    30 0000000C 48893425[08000000]          mov     [.FILE], rsi           ; сохраняется указатель на файл
    31                                  
    32                                      ; Вычисление вещественного значения копмдексного числа (адрес уже в rdi)
    33 00000014 E8(00000000)                call    RealComplex
    34 00000019 F20F110425-                 movsd   [.p], xmm0          ; сохранение (может лишнее) вещественного значения
    34 0000001E [10000000]         
    35                                  
    36                                      ; Вывод информации о комплексном числе в консоль
    37                                  ;     mov     rdi, .outfmt        ; Формат - 1-й аргумент
    38                                  ;     mov     rax, [.pcomp]       ; адрес косплексного числа
    39                                  ;     mov     esi, [rax]          ; x
    40                                  ;     mov     edx, [rax+4]        ; y
    41                                  ;     movsd   xmm0, [.p]
    42                                  ;     mov     rax, 1              ; есть числа с плавающей точкой
    43                                  ;     call    printf
    44                                  
    45                                      ; Вывод информации о комплексном числе в файл
    46 00000022 488B3C25[08000000]          mov     rdi, [.FILE]
    47 0000002A 48BE-                       mov     rsi, .outfmt        ; Формат - 2-й аргумент
    47 0000002C [0000000000000000] 
    48 00000034 488B0425[00000000]          mov     rax, [.pcomp]       ; адрес комплексного числа
    49 0000003C 8B10                        mov     edx, [rax]          ; x
    50 0000003E 8B4804                      mov     ecx, [rax+4]        ; y
    51 00000041 F20F100425-                 movsd   xmm0, [.p]
    51 00000046 [10000000]         
    52 0000004A B801000000                  mov     rax, 1              ; есть числа с плавающей точкой
    53 0000004F E8(00000000)                call    fprintf
    54                                  
    55 00000054 C9                      leave
    56 00000055 C3                      ret
    57                                  
    58                                  ;----------------------------------------------
    59                                  ; Вывод параметров дроби в файл
    60                                  ;----------------------------------------------
    61                                  global OutFraction
    62                                  OutFraction:
    63                                  section .data
    64 0000002A 497420697320467261-         .outfmt db "It is Fraction: a = %d, b = %d. Real = %g",10,0
    64 00000033 6374696F6E3A206120-
    64 0000003C 3D2025642C2062203D-
    64 00000045 2025642E205265616C-
    64 0000004E 203D2025670A00     
    65                                  section .bss
    66 00000018 <res 00000008>              .pfrac  resq  1
    67 00000020 <res 00000008>              .FILE   resq  1       ; временное хранение указателя на файл
    68 00000028 <res 00000008>              .p      resq  1       ; вычисленное вещественное значение дроби
    69                                  section .text
    70 00000056 55                      push rbp
    71 00000057 4889E5                  mov rbp, rsp
    72                                  
    73                                      ; Сохранени принятых аргументов
    74 0000005A 48893C25[18000000]          mov     [.pfrac], rdi         ; сохраняется адрес дроби
    75 00000062 48893425[20000000]          mov     [.FILE], rsi          ; сохраняется указатель на файл
    76                                  
    77                                      ; Вычисление вещественного значения дроби (адрес уже в rdi)
    78 0000006A E8(00000000)                call    RealFraction
    79 0000006F F20F110425-                 movsd   [.p], xmm0          ; сохранение (может лишнее) вещественного значения
    79 00000074 [28000000]         
    80                                  
    81                                      ; Вывод информации о дроби в консоль
    82                                  ;     mov     rdi, .outfmt        ; Формат - 1-й аргумент
    83                                  ;     mov     rax, [.pfrac]       ; адрес треугольника
    84                                  ;     mov     esi, [rax]          ; числитель
    85                                  ;     mov     edx, [rax+4]        ; знаменатель
    86                                  ;     movsd   xmm0, [.p]
    87                                  ;     mov     rax, 1              ; есть числа с плавающей точкой
    88                                  ;     call    printf
    89                                  
    90                                      ; Вывод информации о дроби в файл
    91 00000078 488B3C25[20000000]          mov     rdi, [.FILE]
    92 00000080 48BE-                       mov     rsi, .outfmt        ; Формат - 2-й аргумент
    92 00000082 [2A00000000000000] 
    93 0000008A 488B0425[18000000]          mov     rax, [.pfrac]       ; адрес дроби
    94 00000092 8B10                        mov     edx, [rax]          ; числитель
    95 00000094 8B4804                      mov     ecx, [rax+4]        ; знаменатель
    96 00000097 F20F100425-                 movsd   xmm0, [.p]
    96 0000009C [28000000]         
    97 000000A0 B801000000                  mov     rax, 1              ; есть числа с плавающей точкой
    98 000000A5 E8(00000000)                call    fprintf
    99                                  
   100 000000AA C9                      leave
   101 000000AB C3                      ret
   102                                  
   103                                  ;----------------------------------------------
   104                                  ; Вывод параметров полярной координаты в файл
   105                                  ;----------------------------------------------
   106                                  global OutPolar
   107                                  OutPolar:
   108                                  section .data
   109 00000055 497420697320506F6C-         .outfmt db "It is Polar: r = %d, phi = %d. Real = %g",10,0
   109 0000005E 61723A2072203D2025-
   109 00000067 642C20706869203D20-
   109 00000070 25642E205265616C20-
   109 00000079 3D2025670A00       
   110                                  section .bss
   111 00000030 <res 00000008>              .ppol  resq  1
   112 00000038 <res 00000008>              .FILE   resq  1       ; временное хранение указателя на файл
   113 00000040 <res 00000008>              .p      resq  1       ; вычисленное вещественное значение полярной координаты
   114                                  section .text
   115 000000AC 55                      push rbp
   116 000000AD 4889E5                  mov rbp, rsp
   117                                  
   118                                      ; Сохранени принятых аргументов
   119 000000B0 48893C25[30000000]          mov     [.ppol], rdi          ; сохраняется адрес полярной координаты
   120 000000B8 48893425[38000000]          mov     [.FILE], rsi          ; сохраняется указатель на файл
   121                                  
   122                                      ; Вычисление вещественного значения полярной координаты (адрес уже в rdi)
   123 000000C0 E8(00000000)                call    RealPolar
   124 000000C5 F20F110425-                 movsd   [.p], xmm0          ; сохранение (может лишнее) вещественного значения
   124 000000CA [40000000]         
   125                                  
   126                                      ; Вывод информации о полярной координате в консоль
   127                                  ;     mov     rdi, .outfmt        ; Формат - 1-й аргумент
   128                                  ;     mov     rax, [.ppol]        ; адрес треугольника
   129                                  ;     mov     esi, [rax]          ; r
   130                                  ;     mov     edx, [rax+4]        ; phi
   131                                  ;     movsd   xmm0, [.p]
   132                                  ;     mov     rax, 1              ; есть числа с плавающей точкой
   133                                  ;     call    printf
   134                                  
   135                                      ; Вывод информации о полярной координате в файл
   136 000000CE 488B3C25[38000000]          mov     rdi, [.FILE]
   137 000000D6 48BE-                       mov     rsi, .outfmt        ; Формат - 2-й аргумент
   137 000000D8 [5500000000000000] 
   138 000000E0 488B0425[30000000]          mov     rax, [.ppol]      ; адрес треугольника
   139 000000E8 8B10                        mov     edx, [rax]          ; r
   140 000000EA 8B4804                      mov     ecx, [rax+4]        ; phi
   141 000000ED F20F100425-                 movsd   xmm0, [.p]
   141 000000F2 [40000000]         
   142 000000F6 B801000000                  mov     rax, 1              ; есть числа с плавающей точкой
   143 000000FB E8(00000000)                call    fprintf
   144                                  
   145 00000100 C9                      leave
   146 00000101 C3                      ret
   147                                  
   148                                  ;----------------------------------------------
   149                                  ; Вывод параметров текущего числа в файл
   150                                  ;----------------------------------------------
   151                                  global OutNumber
   152                                  OutNumber:
   153                                  section .data
   154 0000007F 496E636F7272656374-         .erNumber db "Incorrect number!",10,0
   154 00000088 206E756D626572210A-
   154 00000091 00                 
   155                                  section .text
   156 00000102 55                      push rbp
   157 00000103 4889E5                  mov rbp, rsp
   158                                  
   159                                      ; В rdi адрес фигуры
   160 00000106 8B07                        mov eax, [rdi]
   161 00000108 3B0425[00000000]            cmp eax, [COMPLEX]
   162 0000010F 7428                        je compOut
   163 00000111 3B0425[00000000]            cmp eax, [FRACTION]
   164 00000118 742A                        je fracOut
   165 0000011A 3B0425[00000000]            cmp eax, [POLAR]
   166 00000121 742C                        je polOut
   167 00000123 48BF-                       mov rdi, .erNumber
   167 00000125 [7F00000000000000] 
   168 0000012D B800000000                  mov rax, 0
   169 00000132 E8(00000000)                call fprintf
   170 00000137 EB1F                        jmp     return
   171                                  compOut:
   172                                      ; Вывод комплексного числа
   173 00000139 4883C704                    add     rdi, 4
   174 0000013D E8BEFEFFFF                  call    OutComplex
   175 00000142 EB14                        jmp     return
   176                                  fracOut:
   177                                      ; Вывод дроби
   178 00000144 4883C704                    add     rdi, 4
   179 00000148 E809FFFFFF                  call    OutFraction
   180 0000014D EB09                        jmp     return
   181                                  polOut:
   182                                      ; Вывод полярной координаты
   183 0000014F 4883C704                    add     rdi, 4
   184 00000153 E854FFFFFF                  call    OutPolar
   185                                  return:
   186 00000158 C9                      leave
   187 00000159 C3                      ret
   188                                  
   189                                  ;----------------------------------------------
   190                                  ;  Вывод содержимого контейнера в файл
   191                                  ;----------------------------------------------
   192                                  global OutContainer
   193                                  OutContainer:
   194                                  section .data
   195 00000092 25643A2000                  numFmt  db  "%d: ",0
   196                                  section .bss
   197 00000048 <res 00000008>              .pcont  resq    1   ; адрес контейнера
   198 00000050 <res 00000004>              .len    resd    1   ; адрес для сохранения числа введенных элементов
   199 00000054 <res 00000008>              .FILE   resq    1   ; указатель на файл
   200                                  section .text
   201 0000015A 55                      push rbp
   202 0000015B 4889E5                  mov rbp, rsp
   203                                  
   204 0000015E 48893C25[48000000]          mov [.pcont], rdi    ; сохраняется указатель на контейнер
   205 00000166 893425[50000000]            mov [.len],   esi    ; сохраняется число элементов
   206 0000016D 48891425[54000000]          mov [.FILE],  rdx    ; сохраняется указатель на файл
   207                                  
   208                                      ; В rdi адрес начала контейнера
   209 00000175 4889F3                      mov rbx, rsi            ; число чисел
   210 00000178 31C9                        xor ecx, ecx            ; счетчик фигур = 0
   211 0000017A 4889D6                      mov rsi, rdx            ; перенос указателя на файл
   212                                  .loop:
   213 0000017D 39D9                        cmp ecx, ebx            ; проверка на окончание цикла
   214 0000017F 7D4D                        jge .return             ; Перебрали все числа
   215                                  
   216 00000181 53                          push rbx
   217 00000182 51                          push rcx
   218                                  
   219                                      ; Вывод номера числа
   220 00000183 488B3C25[54000000]          mov     rdi, [.FILE]    ; текущий указатель на файл
   221 0000018B 48BE-                       mov     rsi, numFmt     ; формат для вывода числа
   221 0000018D [9200000000000000] 
   222 00000195 89CA                        mov     edx, ecx        ; индекс текущего числа
   223 00000197 4831C0                      xor     rax, rax,       ; только целочисленные регистры
   224 0000019A E8(00000000)                call fprintf
   225                                  
   226                                      ; Вывод текущего числа
   227 0000019F 488B3C25[48000000]          mov     rdi, [.pcont]
   228 000001A7 488B3425[54000000]          mov     rsi, [.FILE]
   229 000001AF E84EFFFFFF                  call OutNumber     ; Получение периметра первого числа
   230                                  
   231 000001B4 59                          pop rcx
   232 000001B5 5B                          pop rbx
   233 000001B6 FFC1                        inc ecx                 ; индекс следующего числа
   234                                  
   235 000001B8 488B0425[48000000]          mov     rax, [.pcont]
   236 000001C0 4883C010                    add     rax, 16         ; адрес следующего числа
   237 000001C4 48890425[48000000]          mov     [.pcont], rax
   238 000001CC EBAF                        jmp .loop
   239                                  .return:
   240 000001CE C9                      leave
   241 000001CF C3                      ret
   242                                  
